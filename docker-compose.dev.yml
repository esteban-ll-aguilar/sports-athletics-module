version: "3.9"

services:
  # ============================================
  # Inicialización de Spring Boot necesario para la creacion del usuario admin
  # ============================================
  init-springboot:
    image: curlimages/curl:latest
    container_name: springboot-init
    depends_on:
      - springboot-app
    command: >
      sh -c "
        echo 'Esperando a que Spring Boot esté listo...';
        until curl -f http://springboot-app:8096/actuator/health 2>/dev/null || curl -f http://springboot-app:8096/ 2>/dev/null; do
          sleep 2;
        done;
        echo 'Spring Boot está listo. Creando usuario por defecto...';
        curl -X GET http://springboot-app:8096/api/config/create;
        echo 'Usuario creado exitosamente';
      "
    restart: "no"

  # ============================================
  # API Principal (Python/FastAPI)
  # ============================================
  fastapi-app:
    build:
      context: ./athletics_fastapi
      dockerfile: Dockerfile
    image: athletics_fastapi:latest
    container_name: fastapi-app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      springboot-app:
        condition: service_started
    ports:
      - "8080:8080"
    environment:
      # Configuración de la aplicación
      APPLICATION_HOST: 0.0.0.0
      APPLICATION_PORT: 8080
      APPLICATION_VERSION: 1.0.0

      # Base de datos PostgreSQL
      DATABASE_URL: postgresql://postgres:123456@postgres:5432/BaseDeDatos
      DATABASE_NAME: BaseDeDatos
      DATABASE_USER: postgres
      DATABASE_PASSWORD: 123456
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      
      # Database Pool Configuration
      DATABASE_POOL_SIZE: 5
      DATABASE_MAX_OVERFLOW: 5
      DATABASE_POOL_TIMEOUT: 30
      DATABASE_POOL_RECYCLE: 3600

      # Redis
      REDIS_URL: redis://redis:6379/0

      # CORS
      CORS_ALLOW_ORIGINS: "*"
      CORS_ALLOW_CREDENTIALS: "true"
      CORS_ALLOW_METHODS: "*"
      CORS_ALLOW_HEADERS: "*"

      # JWT
      JWT_ALGORITHM: HS256
      JWT_SECRET: CHANGE_ME_SUPER_SECRET
      ACCESS_TOKEN_EXPIRES_MINUTES: 15
      REFRESH_TOKEN_EXPIRES_DAYS: 7

      # Email (valores de prueba para desarrollo)
      EMAIL_HOST: smtp.gmail.com
      EMAIL_PORT: 587
      EMAIL_USE_TLS: "true"
      EMAIL_HOST_USER: test@example.com
      EMAIL_HOST_PASSWORD: test_password

      # API de usuarios (microservicio Spring Boot)
      USERS_API_URL: http://springboot-app:8096
      USERS_API_EMAIL: admin@admin.com
      USERS_API_PASSWORD: admin

      # Debug
      DEBUG: "false"

      # Enable test routes for stress testing
      ENABLE_TEST_ROUTES: "true"
    networks:
      - app-network
    restart: unless-stopped

  
  # ============================================
  # Microservicio de Usuarios (Spring Boot)
  # ============================================
  springboot-app:
    image: joseguaman1/users-docker:v1
    container_name: springboot-app
    depends_on:
      - mariadb
    ports:
      - "8096:8096"
    environment:
      SPRING_APPLICATION_NAME: user

      SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb:3306/sportDB
      SPRING_DATASOURCE_USERNAME: desarrollo
      SPRING_DATASOURCE_PASSWORD: desarrollo
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.mariadb.jdbc.Driver

      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_DOCKER_COMPOSE_ENABLED: "false"

      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://localhost:4200,http://localhost,http://localhost:8080
      CORS_ALLOWED_METHODS: GET,POST,PUT,DELETE,OPTIONS
      CORS_ALLOWED_HEADERS: "*"
      CORS_ALLOW_CREDENTIALS: "true"

      OTHERS_KEY: 1234567FDUCAMETB

      SERVER_PORT: 8096
    networks:
      - app-network

  # ============================================
  # Base de Datos MariaDB (para Spring Boot)
  # ============================================
  mariadb:
    image: mariadb:11
    container_name: mariadb-db
    environment:
      MARIADB_ROOT_PASSWORD: rootpass
      MARIADB_DATABASE: sportDB
      MARIADB_USER: desarrollo
      MARIADB_PASSWORD: desarrollo
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - app-network

  # ============================================
  # Base de Datos PostgreSQL (para FastAPI)
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: postgres-db
    environment:
      POSTGRES_DB: BaseDeDatos
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123456
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d BaseDeDatos"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    command:
      - "postgres"
      - "-c"
      - "max_connections=300"  # Aumentar para soportar 3 instancias API + stress test
      - "-c"
      - "shared_buffers=512MB"  # Cache mejorado para alta concurrencia
      - "-c"
      - "effective_cache_size=2GB"
      - "-c"
      - "work_mem=8MB"  # Reducir para permitir más conexiones concurrentes
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "max_wal_size=2GB"  # Checkpoint menos frecuentes
      - "-c"
      - "checkpoint_completion_target=0.9"  # Suavizar I/O
      - "-c"
      - "random_page_cost=1.1"  # Optimizado para SSD
    networks:
      - app-network

  # ============================================
  # Redis (para FastAPI - cache/sesiones)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: redis-cache
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - app-network

  # ============================================
  # Frontend (Vite UI)
  # ============================================
  frontend:
    build:
      context: ./athletics_vite_ui
      dockerfile: Dockerfile
    image: athletics_vite_ui:latest
    container_name: vite-ui
    depends_on:
      - fastapi-app
    ports:
      - "5173:80"
    environment:
      - VITE_API_URL=http://localhost:8080
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  mariadb_data:
  postgres_data:
  redis_data:


