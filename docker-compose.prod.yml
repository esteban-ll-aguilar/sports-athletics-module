version: "3.9"

# ============================================
# Docker Compose para PRODUCCIÓN
# ============================================
# IMPORTANTE: Configurar todas las variables de entorno
# antes de usar en producción

services:
  # ============================================
  # Inicialización de Spring Boot
  # ============================================
  init-springboot:
    image: curlimages/curl:latest
    container_name: springboot-init-prod
    depends_on:
      - springboot-app
    command: >
      sh -c "
        echo 'Esperando a que Spring Boot esté listo...';
        until curl -f http://springboot-app:8096/actuator/health 2>/dev/null || curl -f http://springboot-app:8096/ 2>/dev/null; do
          sleep 2;
        done;
        echo 'Spring Boot está listo. Creando usuario por defecto...';
        curl -X GET http://springboot-app:8096/api/config/create;
        echo 'Usuario creado exitosamente';
      "
    restart: "no"
    networks:
      - app-network

  # ============================================
  # API Principal (Python/FastAPI)
  # ============================================
  fastapi-app:
    image: ${DOCKER_REGISTRY:-docker.io}/athletics-fastapi:${IMAGE_TAG:-latest}
    container_name: fastapi-app-prod
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      springboot-app:
        condition: service_started
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    env_file:
      - ./athletics_fastapi/.env.production
    environment:
      # Override critical production values
      APPLICATION_HOST: 0.0.0.0
      APPLICATION_PORT: 8080
      ENV: production
      DEBUG: "false"
    volumes:
      - fastapi_data:/app/data
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # Microservicio de Usuarios (Spring Boot)
  # ============================================
  springboot-app:
    image: joseguaman1/users-docker:v1
    container_name: springboot-app-prod
    depends_on:
      - mariadb
    ports:
      - "${SPRINGBOOT_PORT:-8096}:8096"
    environment:
      SPRING_APPLICATION_NAME: user
      SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb:3306/${MARIADB_DATABASE:-sportDB}
      SPRING_DATASOURCE_USERNAME: ${MARIADB_USER:-desarrollo}
      SPRING_DATASOURCE_PASSWORD: ${MARIADB_PASSWORD:-desarrollo}
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.mariadb.jdbc.Driver
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "false"
      SPRING_DOCKER_COMPOSE_ENABLED: "false"
      CORS_ALLOWED_ORIGINS: ${CORS_ORIGINS:-https://yourdomain.com}
      CORS_ALLOWED_METHODS: GET,POST,PUT,DELETE,OPTIONS
      CORS_ALLOWED_HEADERS: "*"
      CORS_ALLOW_CREDENTIALS: "true"
      OTHERS_KEY: ${SPRING_OTHERS_KEY:-1234567FDUCAMETB}
      SERVER_PORT: 8096
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # Base de Datos MariaDB (para Spring Boot)
  # ============================================
  mariadb:
    image: mariadb:11
    container_name: mariadb-prod
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD:-CHANGE_IN_PRODUCTION}
      MARIADB_DATABASE: ${MARIADB_DATABASE:-sportDB}
      MARIADB_USER: ${MARIADB_USER:-desarrollo}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD:-CHANGE_IN_PRODUCTION}
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================
  # Base de Datos PostgreSQL (para FastAPI)
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: postgres-prod
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-BaseDeDatos}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-CHANGE_IN_PRODUCTION}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-BaseDeDatos}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command:
      - "postgres"
      - "-c"
      - "max_connections=300"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "effective_cache_size=2GB"
      - "-c"
      - "work_mem=8MB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "max_wal_size=2GB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "random_page_cost=1.1"
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # Redis (para FastAPI - cache/sesiones)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: redis-prod
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD:-CHANGE_IN_PRODUCTION}
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ============================================
  # Frontend (Vite UI)
  # ============================================
  frontend:
    image: ${DOCKER_REGISTRY:-docker.io}/athletics-vite-ui:${IMAGE_TAG:-latest}
    container_name: vite-ui-prod
    depends_on:
      - fastapi-app
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      - VITE_API_URL=${VITE_API_URL:-https://api.yourdomain.com}
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

networks:
  app-network:
    driver: bridge

volumes:
  mariadb_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  fastapi_data:
    driver: local
