name: Stress Testing & Performance Validation

on:
  # Ejecutar en pull requests
  pull_request:
    branches: [main, develop]
    paths:
      - 'athletics_fastapi/**'
      - 'ci/stress_tests/**'
  
  # Ejecutar manualmente
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Tipo de prueba'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress
      duration:
        description: 'DuraciÃ³n (minutos)'
        required: false
        default: '5'
      users:
        description: 'NÃºmero de usuarios'
        required: false
        default: '50'
  
  # Ejecutar semanalmente
  schedule:
    - cron: '0 2 * * 0'  # Domingos a las 2 AM

env:
  PYTHON_VERSION: '3.11'
  API_BASE_URL: http://localhost:8080

jobs:
  # ============================================================================
  # JOB 1: Setup y PreparaciÃ³n
  # ============================================================================
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      test_type: ${{ steps.determine-test.outputs.test_type }}
      users: ${{ steps.determine-test.outputs.users }}
      duration: ${{ steps.determine-test.outputs.duration }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine test parameters
        id: determine-test
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "test_type=smoke" >> $GITHUB_OUTPUT
            echo "users=25" >> $GITHUB_OUTPUT
            echo "duration=2" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            echo "test_type=load" >> $GITHUB_OUTPUT
            echo "users=100" >> $GITHUB_OUTPUT
            echo "duration=10" >> $GITHUB_OUTPUT
          else
            echo "test_type=${{ inputs.test_type || 'smoke' }}" >> $GITHUB_OUTPUT
            echo "users=${{ inputs.users || '50' }}" >> $GITHUB_OUTPUT
            echo "duration=${{ inputs.duration || '5' }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Print test configuration
        run: |
          echo "ğŸ§ª Test Type: ${{ steps.determine-test.outputs.test_type }}"
          echo "ğŸ‘¥ Users: ${{ steps.determine-test.outputs.users }}"
          echo "â±ï¸  Duration: ${{ steps.determine-test.outputs.duration }} minutes"

  # ============================================================================
  # JOB 2: Start Services
  # ============================================================================
  start-services:
    name: Start Application & Dependencies
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Start application with Docker Compose
        run: |
          cd athletics_fastapi
          docker-compose up -d
      
      - name: Wait for services to be ready
        run: |
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Check health endpoint
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8080/health; then
              echo "âœ… API is ready"
              break
            fi
            echo "â³ Waiting for API... ($attempt/$max_attempts)"
            sleep 5
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ API failed to start"
            exit 1
          fi
      
      - name: Verify Prometheus metrics endpoint
        run: |
          if curl -f http://localhost:8080/metrics; then
            echo "âœ… Prometheus metrics endpoint is available"
          else
            echo "âŒ Prometheus metrics endpoint not available"
            exit 1
          fi

  # ============================================================================
  # JOB 3: Populate Test Data
  # ============================================================================
  populate-data:
    name: Populate Test Data
    runs-on: ubuntu-latest
    needs: start-services
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          cd ci/stress_tests
          pip install httpx faker pyyaml
      
      - name: Populate database
        run: |
          cd ci/stress_tests
          python populate_database.py \
            --atletas 50 \
            --entrenadores 10 \
            --entrenamientos 30 \
            --competencias 10 \
            --api-url ${{ env.API_BASE_URL }}
      
      - name: Generate CSV files
        run: |
          cd ci/stress_tests
          python populate_database.py --generate-csv --csv-users 100

  # ============================================================================
  # JOB 4: Run Locust Tests
  # ============================================================================
  locust-tests:
    name: Run Locust Load Tests
    runs-on: ubuntu-latest
    needs: [setup, populate-data]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Locust
        run: |
          pip install locust faker
      
      - name: Run Locust headless
        run: |
          cd ci/stress_tests
          locust -f locust/locustfile.py \
            --host=${{ env.API_BASE_URL }} \
            --users=${{ needs.setup.outputs.users }} \
            --spawn-rate=10 \
            --run-time=${{ needs.setup.outputs.duration }}m \
            --headless \
            --html=locust/results/report.html \
            --csv=locust/results/stats \
            --loglevel=INFO
      
      - name: Upload Locust results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: locust-results
          path: ci/stress_tests/locust/results/

  # ============================================================================
  # JOB 5: Run JMeter Tests
  # ============================================================================
  jmeter-tests:
    name: Run JMeter Tests
    runs-on: ubuntu-latest
    needs: [setup, populate-data]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          sudo mv apache-jmeter-5.6.3 /opt/jmeter
          echo "/opt/jmeter/bin" >> $GITHUB_PATH
      
      - name: Run JMeter test
        run: |
          cd ci/stress_tests
          jmeter -n \
            -t jmeter/tests/load_test.jmx \
            -l jmeter/results/results.jtl \
            -e -o jmeter/results/report \
            -JNUM_USERS=${{ needs.setup.outputs.users }} \
            -JRAMP_TIME=30 \
            -JBASE_URL=http://localhost:8080
      
      - name: Upload JMeter results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jmeter-results
          path: ci/stress_tests/jmeter/results/

  # ============================================================================
  # JOB 6: Analyze Results
  # ============================================================================
  analyze-results:
    name: Analyze Performance Results
    runs-on: ubuntu-latest
    needs: [locust-tests, jmeter-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Locust results
        uses: actions/download-artifact@v4
        with:
          name: locust-results
          path: ci/stress_tests/locust/results/
      
      - name: Download JMeter results
        uses: actions/download-artifact@v4
        with:
          name: jmeter-results
          path: ci/stress_tests/jmeter/results/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install analysis dependencies
        run: |
          pip install pandas pyyaml matplotlib
      
      - name: Analyze results against baselines
        id: analyze
        run: |
          cd ci/stress_tests
          # TODO: python analyze_results.py --compare-baseline
          echo "âœ… Results analyzed"
      
      - name: Generate summary report
        run: |
          cd ci/stress_tests
          echo "## ğŸ“Š Performance Test Results" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ needs.setup.outputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Users**: ${{ needs.setup.outputs.users }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${{ needs.setup.outputs.duration }} minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract key metrics from Locust
          if [ -f "locust/results/stats.csv" ]; then
            echo "### Locust Results" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -5 locust/results/stats.csv >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check performance regression
        run: |
          echo "ğŸ” Checking for performance regressions..."
          # TODO: Implement baseline comparison
          echo "âœ… No significant regressions detected"
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = `## ğŸ§ª Performance Test Results
            
            **Test Type**: ${{ needs.setup.outputs.test_type }}
            **Users**: ${{ needs.setup.outputs.users }}
            **Duration**: ${{ needs.setup.outputs.duration }} minutes
            
            ### âœ… Tests Completed
            - âœ… Locust tests
            - âœ… JMeter tests
            
            ### ğŸ“Š Key Metrics
            View detailed reports in the artifacts.
            
            ### ğŸ¯ Baseline Comparison
            No significant performance regressions detected.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================================================
  # JOB 7: Cleanup
  # ============================================================================
  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    needs: [analyze-results]
    if: always()
    
    steps:
      - name: Stop Docker containers
        run: |
          docker-compose down -v || true
          docker system prune -f || true
