name: CI - Development

on:
  push:
    branches: [ "development" ]

jobs:
  # ============================================
  # JOB 1: Setup & Validation
  # ============================================
  setup:
    name: ðŸ” Setup & Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate project structure
      run: |
        echo "âœ… Validating project structure..."
        test -d athletics_fastapi && echo "âœ… Backend folder found"
        test -d athletics_vite_ui && echo "âœ… Frontend folder found"
        
    - name: Check dependencies files
      run: |
        test -f athletics_fastapi/requirements.txt && echo "âœ… requirements.txt found"
        test -f athletics_vite_ui/package.json && echo "âœ… package.json found"

  # ============================================
  # JOB 2: Backend Tests
  # ============================================
  backend-tests:
    name: ðŸ Backend Tests
    runs-on: ubuntu-latest
    needs: setup
    defaults:
      run:
        working-directory: ./athletics_fastapi
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'
        cache-dependency-path: './athletics_fastapi/requirements.txt'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Backend dependencies installed"

    - name: Run Unit Tests
      env:
        DATABASE_NAME: test_db
        DATABASE_USER: postgres
        DATABASE_PASSWORD: postgres
        DATABASE_HOST: localhost
        DATABASE_PORT: 5432
        REDIS_URL: redis://localhost:6379/0
        CORS_ALLOW_ORIGINS: "*"
        CORS_ALLOW_METHODS: "*"
        CORS_ALLOW_HEADERS: "*"
        JWT_ALGORITHM: HS256
        JWT_SECRET: test_secret_key_for_ci
        ACCESS_TOKEN_EXPIRES_MINUTES: 15
        REFRESH_TOKEN_EXPIRES_DAYS: 7
        EMAIL_HOST: smtp.gmail.com
        EMAIL_PORT: 587
        EMAIL_USE_TLS: true
        EMAIL_HOST_USER: test@example.com
        EMAIL_HOST_PASSWORD: test_password
        USERS_API_URL: http://localhost:8081
        USERS_API_EMAIL: test@example.com
        USERS_API_PASSWORD: test_password
      run: |
        echo "ðŸ§ª Running backend unit tests..."
        pytest -c ./tests/pytest.ini --verbose --tb=short
        echo "âœ… Backend tests passed"

    - name: Upload Coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage-develop
        path: athletics_fastapi/htmlcov/
        retention-days: 30

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-test-results
        path: |
          athletics_fastapi/test-results.xml
          athletics_fastapi/.coverage
        retention-days: 30

  # ============================================
  # JOB 3: Frontend Tests
  # ============================================
  frontend-tests:
    name: âš›ï¸ Frontend Tests
    runs-on: ubuntu-latest
    needs: setup
    defaults:
      run:
        working-directory: ./athletics_vite_ui
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: './athletics_vite_ui/package-lock.json'

    - name: Install Dependencies
      run: |
        npm ci
        echo "âœ… Frontend dependencies installed"

    - name: Run Unit Tests
      run: |
        echo "ðŸ§ª Running frontend unit tests..."
        npm run test -- --run --reporter=verbose
        echo "âœ… Frontend tests passed"

    - name: Upload Coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage-develop
        path: athletics_vite_ui/coverage/
        retention-days: 30

  # ============================================
  # JOB 4: Final Report
  # ============================================
  final-report:
    name: ðŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: always()
    
    steps:
    - name: Generate Summary
      run: |
        echo "## ðŸŽ‰ Development CI Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Jobs Status:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Setup & Validation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Backend Tests" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Frontend Tests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** development" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        
    - name: Celebrate Success
      run: |
        echo "============================================"
        echo "ðŸŽŠ All checks passed! ðŸŽŠ"
        echo "============================================"
