name: CI - Main

on:
  push:
    branches: [ "main" ]

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ============================================
    # Setup Backend Environment
    # ============================================
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'
        cache-dependency-path: './athletics_fastapi/requirements.txt'

    - name: Install Backend Dependencies
      working-directory: ./athletics_fastapi
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Backend dependencies installed"

    # ============================================
    # Setup Frontend Environment
    # ============================================
    - name: Set up Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: './athletics_vite_ui/package-lock.json'

    - name: Install Frontend Dependencies
      working-directory: ./athletics_vite_ui
      run: |
        npm ci
        echo "âœ… Frontend dependencies installed"

    # ============================================
    # Run Tests in Parallel
    # ============================================
    - name: Run Backend Tests
      working-directory: ./athletics_fastapi
      run: |
        echo "ğŸ§ª Running backend unit tests..."
        pytest -c ./tests/pytest.ini --verbose --tb=short
        echo "âœ… Backend tests passed"

    - name: Run Frontend Tests
      working-directory: ./athletics_vite_ui
      run: |
        echo "ğŸ§ª Running frontend unit tests..."
        npm run test -- --run --reporter=verbose
        echo "âœ… Frontend tests passed"

    # ============================================
    # Build Docker Images
    # ============================================
    - name: Build Backend Image
      run: |
        echo "ğŸ³ Building backend Docker image..."
        docker build -t athletics-backend:${{ github.sha }} ./athletics_fastapi
        echo "âœ… Backend image built successfully"

    - name: Build Frontend Image
      run: |
        echo "ğŸ³ Building frontend Docker image..."
        docker build -t athletics-frontend:${{ github.sha }} ./athletics_vite_ui
        echo "âœ… Frontend image built successfully"

    # ============================================
    # Upload Test Results
    # ============================================
    - name: Upload Backend Coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage-main
        path: athletics_fastapi/htmlcov/
        retention-days: 30

    - name: Upload Frontend Coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage-main
        path: athletics_vite_ui/coverage/
        retention-days: 30

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-main
        path: |
          athletics_fastapi/test-results.xml
          athletics_fastapi/.coverage
        retention-days: 30

    # ============================================
    # Summary
    # ============================================
    - name: Build Summary
      if: always()
      run: |
        echo "============================================"
        echo "âœ… Main Branch Build Completed"
        echo "============================================"
        echo "Branch: main"
        echo "Commit: ${{ github.sha }}"
        echo "Backend Tests: Passed"
        echo "Frontend Tests: Passed"
        echo "Docker Images: Built"
        echo "============================================"
